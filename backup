#!/usr/bin/env bash

PKGS_LIST="/boot/backup/packages.list"
PKGS_AUR_LIST="/boot/backup/packages-aur.list"
SRVCS_LIST="/boot/backup/services.list"
SRVCS_USER_LIST="/boot/backup/services-user.list"
CFGS_LIST="/boot/backup/configs.list"
CFGS_PACK="/boot/backup/configs-$(date +%Y%m%d-%H%M%S).tar.xz"

set -e

# Installed packages list
pacman -Qqem | sort | sudo tee "${PKGS_AUR_LIST}"
comm -23 <(pacman -Qqe | sort) <(cat "${PKGS_AUR_LIST}") | sudo tee "${PKGS_LIST}"
# Enabled services
systemctl list-unit-files --no-legend --type=service --state=enabled \
    | grep -v "^systemd" | cut -f1 -d' ' | sudo tee "${SRVCS_LIST}"
systemctl --user list-unit-files --no-legend --state=enabled \
    --type=service --type=timer |  cut -f1 -d' '| sudo tee "${SRVCS_USER_LIST}"
# Store configs in on EFI partition
sudo tar --exclude='/home/shared/.tmp/*' --exclude='/home/shared/Games/*' \
     --exclude='/home/shared/Torrents/*' --exclude='**/msmtpq/*' \
     -cvpf "${CFGS_PACK}" -T "${CFGS_LIST}"
# Copy to google drive
cp /boot/backup/* "${XDG_HOME}/var/google/Backup/"
